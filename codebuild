Set up CodeBuild to build & push image

Goal: Build Docker image and push to ECR without Docker locally.

Step 1: Create ECR repo again
aws ecr create-repository --repository-name neelu/demo1 --region us-east-1


Copy repository URI:
654654362568.dkr.ecr.us-east-1.amazonaws.com/neelu/demo1

Step 2: Create project folder in CloudShell
mkdir codebuild-demo && cd codebuild-demo

app.py
cat <<EOF > app.py
print("Hello from CodeBuild ECR demo")
EOF

Dockerfile
cat <<EOF > Dockerfile
FROM python:3.10-slim
WORKDIR /app
COPY app.py .
CMD ["python", "app.py"]
EOF

Step 3: Create buildspec.yml
version: 0.2

phases:
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - aws ecr get-login-password --region us-east-1 |
        docker login --username AWS --password-stdin 654654362568.dkr.ecr.us-east-1.amazonaws.com
  build:
    commands:
      - echo Build Docker image...
      - docker build -t demo1 .
      - docker tag demo1:latest 654654362568.dkr.ecr.us-east-1.amazonaws.com/neelu/demo1:v1
  post_build:
    commands:
      - echo Push Docker image to ECR...
      - docker push 654654362568.dkr.ecr.us-east-1.amazonaws.com/neelu/demo1:v1

Step 4: Create CodeBuild project

Go to AWS Console ‚Üí CodeBuild ‚Üí Create project

Project name: codebuild-demo

Source: Choose CloudShell folder (or GitHub repo if you push code)

Environment:

Managed image: Amazon Linux 2

Privileged: ‚úÖ ENABLED (required for Docker)

Service role: auto-create (it will include ECR permissions)

Buildspec: Use buildspec.yml from source

Step 5: Start build

Click Start build

Watch logs ‚Üí it will:

Login to ECR

Build image

Tag image

Push image

Check ECR repository ‚Üí image v1 should appear
Ah! That error usually happens in CloudShell when your current working directory path doesn‚Äôt exist or the $HOME directory isn‚Äôt set correctly. Let‚Äôs fix it step by step.

Step 1Ô∏è‚É£ Go to your home directory
cd ~


Check you are in home:

pwd


Expected output:

/home/cloudshell-user

Step 2Ô∏è‚É£ Create the folder
mkdir codebuild-demo
cd codebuild-demo


Now you should be inside codebuild-demo.

Step 3Ô∏è‚É£ Confirm
pwd
ls


pwd ‚Üí /home/cloudshell-user/codebuild-demo

ls ‚Üí should show empty folder

‚úÖ Now you can continue creating:

cat <<EOF > app.py
print("Hello from CodeBuild ECR demo")
EOF


and

cat <<EOF > Dockerfile
FROM python:3.10-slim
WORKDIR /app
COPY app.py .
CMD ["python", "app.py"]
EOF


üí° Tip: Always cd ~ first in CloudShell before creating new folders to avoid ‚ÄúNo such file or directory‚Äù errors.
Step 1Ô∏è‚É£ Make sure you are in your folder
cd ~/codebuild-demo

Step 2Ô∏è‚É£ Create the buildspec.yml file
cat <<EOF > buildspec.yml
version: 0.2

phases:
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 654654362568.dkr.ecr.us-east-1.amazonaws.com
  build:
    commands:
      - echo Build Docker image...
      - docker build -t demo1 .
      - docker tag demo1:latest 654654362568.dkr.ecr.us-east-1.amazonaws.com/neelu/demo1:v1
  post_build:
    commands:
      - echo Push Docker image to ECR...
      - docker push 654654362568.dkr.ecr.us-east-1.amazonaws.com/neelu/demo1:v1
EOF


‚úÖ This will create a file named buildspec.yml in your folder.

Step 3Ô∏è‚É£ Verify the file
cat buildspec.yml


You should see the YAML content printed.
